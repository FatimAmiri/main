

<!DOCTYPE html>
<html lang="en">
    <head>
        <title>COMPAS</title>

        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    
        <meta name="author" content="Tom Van Mele" />
        <meta name="description" content="compas is a computational framework for research in architecture and structures." />

        <link rel="shortcut icon" href="../_static/images/compas.ico" type="image/x-icon">

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous" />

        <link rel="stylesheet" type="text/css" href="../_static/css/prism.css" />
        <link rel="stylesheet" type="text/css" href="../_static/css/compas.css" />
        <link rel="stylesheet" type="text/css" href="../_static/css/compas-reference.css" />

        
            <link rel="next" title="Using geometric maps" href="geomaps.html" />
        
        
        
            <link rel="prev" title="Working with plotters" href="plotters.html" />
        

        <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML"></script>

    </head>
    <body data-spy="scroll" data-target="#compas-localnav">

        <header class="navbar navbar-expand compas-navbar">
            <a class="navbar-brand" href="/">
                <img src="/_static/images/compas_icon_white.png" width="36px" height="36px" alt="compas" />
            </a>

            <ul class="navbar-nav">
                <li class="nav-item ">
                    <a class="nav-link " href="/">Home</a>
                </li>
                <li class="nav-item active">
                    <a class="nav-link active" href="/main/">Documentation</a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link " href="/packages/">Packages</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" target="_blank" href="http://forum.compas-framework.org">Forum</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" target="_blank" href="https://github.com/compas-dev/compas/wiki">Developers</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" target="_blank" href="http://github.com/compas-dev">Github</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" target="_blank" href="https://pypi.org/project/COMPAS/">PyPI</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" target="_blank" href="https://anaconda.org/conda-forge/compas">Anaconda</a>
                </li>
            </ul>
        </header>
        
        <div class="container compas-container">
            <div class="row flex-xl-nowrap">

                <!-- main content -->

                

                <main class="col-12 col-md-9 col-xl-8 compas-content" role="main">

                

                    

                        

                        <div class="section" id="using-callbacks">
<h1>Using callbacks</h1>
<p>COMPAS implements a <em>callback</em> mechanism that provides a consistent way to
customise algorithms, apply constraints, visualise progress of iterative algorithms, …</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>A <em>callback</em> is a function that is passed to another function as a parameter
such that the latter function can call the former at any time during its own
execution. Perhaps the name <em>callback</em> is based on the fact that through the
<em>callback</em> the second function can “call back” into the scope where the first
function was defined. Or perhaps not :), but it is a convenient way to think
about it because at time of execution, the callback has access to the variables
of the scope in which it was defined.</p>
</div>
<p>In principle, the mechanism can be summarised with the following snippets.</p>
<div class="language-python notranslate"><div class="highlight"><pre><code><span></span><span class="c1"># algorithm.py</span>

<span class="k">def</span> <span class="nf">algo</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">callback</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;The callback function is not callable.&#39;</span><span class="p">)</span>

    <span class="c1"># stuff</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">kmax</span><span class="p">):</span>
        <span class="c1"># stuffs</span>

        <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
            <span class="n">callback</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

    <span class="c1"># more stuffs</span>
</code></pre></div>
</div>
<div class="language-python notranslate"><div class="highlight"><pre><code><span></span><span class="c1"># somescript.py</span>

<span class="kn">from</span> <span class="nn">algorithm</span> <span class="kn">import</span> <span class="n">algo</span>

<span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;iteration number:&#39;</span>

<span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>

<span class="n">algo</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">callback</span><span class="p">)</span>
</code></pre></div>
</div>
<p>In this case, the result would be a bit boring, because the callback would simply
print the number of the current iteration of the algorithm. Note, however, that
the callback has access to the variable <code class="docutils literal notranslate"><span class="pre">text</span></code>, even though that ariable was defined
in a different context that the one in which the callback is called.</p>
<div class="section" id="dynamic-plotting">
<h2>Dynamic plotting</h2>
<p>Throughout the main library, callbacks are often used in combination with the plotters
to visualise intermediate steps of an algorithm, or to visualise the progress of
an iterative algorithm. Both can be very useful mechanisms for debugging.</p>
<p>For example, from <a class="reference internal" href="../api/compas.geometry.html#module-compas.geometry" title="compas.geometry"><code class="xref py py-mod docutils literal notranslate"><span class="pre">compas.geometry</span></code></a>, an code snippet visualising the progress
of an iterative smoothing algorithm (<code class="xref py py-func docutils literal notranslate"><span class="pre">compas.geometry.mesh_smooth_centroid()</span></code>).</p>
<div class="language-python notranslate"><div class="highlight"><pre><code><span></span><span class="kn">import</span> <span class="nn">compas</span>

<span class="kn">from</span> <span class="nn">compas.datastructures</span> <span class="kn">import</span> <span class="n">Mesh</span>
<span class="kn">from</span> <span class="nn">compas.plotters</span> <span class="kn">import</span> <span class="n">MeshPlotter</span>
<span class="kn">from</span> <span class="nn">compas.geometry</span> <span class="kn">import</span> <span class="n">mesh_smooth_centroid</span>

<span class="n">mesh</span> <span class="o">=</span> <span class="n">Mesh</span><span class="o">.</span><span class="n">from_obj</span><span class="p">(</span><span class="n">compas</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;faces.obj&#39;</span><span class="p">))</span>

<span class="n">fixed</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">vertices</span><span class="p">()</span> <span class="k">if</span> <span class="n">mesh</span><span class="o">.</span><span class="n">vertex_degree</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span>

<span class="n">plotter</span> <span class="o">=</span> <span class="n">MeshPlotter</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>

<span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">edges</span><span class="p">():</span>
    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s1">&#39;start&#39;</span> <span class="p">:</span> <span class="n">mesh</span><span class="o">.</span><span class="n">vertex_coordinates</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="s1">&#39;xy&#39;</span><span class="p">),</span>
        <span class="s1">&#39;end&#39;</span>   <span class="p">:</span> <span class="n">mesh</span><span class="o">.</span><span class="n">vertex_coordinates</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s1">&#39;xy&#39;</span><span class="p">),</span>
        <span class="s1">&#39;color&#39;</span> <span class="p">:</span> <span class="s1">&#39;#cccccc&#39;</span><span class="p">,</span>
        <span class="s1">&#39;width&#39;</span> <span class="p">:</span> <span class="mf">0.5</span>
    <span class="p">})</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">draw_lines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

<span class="n">plotter</span><span class="o">.</span><span class="n">draw_vertices</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="s1">&#39;#ff0000&#39;</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">fixed</span><span class="p">})</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">draw_faces</span><span class="p">()</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">draw_edges</span><span class="p">()</span>

<span class="n">plotter</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pause</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="n">plotter</span><span class="o">.</span><span class="n">update_vertices</span><span class="p">()</span>
    <span class="n">plotter</span><span class="o">.</span><span class="n">update_faces</span><span class="p">()</span>
    <span class="n">plotter</span><span class="o">.</span><span class="n">update_edges</span><span class="p">()</span>
    <span class="n">plotter</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pause</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>

<span class="n">mesh_smooth_centroid</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">kmax</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="n">fixed</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">callback</span><span class="p">)</span>

<span class="n">plotter</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
</div>
<p>We use a mesh plotter as visualisation tool.</p>
<div class="language-python notranslate"><div class="highlight"><pre><code><span></span><span class="n">plotter</span> <span class="o">=</span> <span class="n">MeshPlotter</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
</code></pre></div>
</div>
<p>First, as a reference, we plot a set of lines corresponding to the original
configuration of the mesh.</p>
<div class="language-python notranslate"><div class="highlight"><pre><code><span></span><span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">mesh</span><span class="o">.</span><span class="n">edges</span><span class="p">():</span>
    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s1">&#39;start&#39;</span> <span class="p">:</span> <span class="n">mesh</span><span class="o">.</span><span class="n">vertex_coordinates</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="s1">&#39;xy&#39;</span><span class="p">),</span>
        <span class="s1">&#39;end&#39;</span>   <span class="p">:</span> <span class="n">mesh</span><span class="o">.</span><span class="n">vertex_coordinates</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s1">&#39;xy&#39;</span><span class="p">),</span>
        <span class="s1">&#39;color&#39;</span> <span class="p">:</span> <span class="s1">&#39;#cccccc&#39;</span><span class="p">,</span>
        <span class="s1">&#39;width&#39;</span> <span class="p">:</span> <span class="mf">0.5</span>
    <span class="p">})</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">draw_lines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
</code></pre></div>
</div>
<p>Then we initialise the vertices, edges and faces that will be updated at every
iteration to visualise the process. We also tell the plotter to pause for a second,
to be able to digest the orginal configuration before the smoothing starts.</p>
<div class="language-python notranslate"><div class="highlight"><pre><code><span></span><span class="n">plotter</span><span class="o">.</span><span class="n">draw_vertices</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="s1">&#39;#ff0000&#39;</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">fixed</span><span class="p">})</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">draw_faces</span><span class="p">()</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">draw_edges</span><span class="p">()</span>

<span class="n">plotter</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pause</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
</code></pre></div>
</div>
<p>The next step is to define the callback function that will update the plotter.
The plotter has dedicated functions for this. They update the geometry of the
collections of vertices, edges and faces while keeping the style attributes as they
were set by the original calls to the draw functions. With a call to the general
update function we update the drawing.</p>
<p>The callback is handed off to the smoothing algorithm, which will call it at every
iteration. By default, the callback receives the mesh object and the number of the
current iteration as firs and second parameter, and then any additional parameters
that were passed to the algorithm.</p>
<div class="language-python notranslate"><div class="highlight"><pre><code><span></span><span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="n">plotter</span><span class="o">.</span><span class="n">update_vertices</span><span class="p">()</span>
    <span class="n">plotter</span><span class="o">.</span><span class="n">update_faces</span><span class="p">()</span>
    <span class="n">plotter</span><span class="o">.</span><span class="n">update_edges</span><span class="p">()</span>
    <span class="n">plotter</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pause</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>

<span class="n">mesh_smooth_centroid</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">kmax</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="n">fixed</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">callback</span><span class="p">)</span>
</code></pre></div>
</div>
<p>Finally, we make sure that the plotting window remains active and visible.</p>
<div class="language-python notranslate"><div class="highlight"><pre><code><span></span><span class="n">plotter</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
</div>
<p>The result shpould be something like this.</p>
<div class="figure align-center">
<img alt="../_images/tutorial_callbacks_smoothing.gif" class="figure-img img-fluid" src="../_images/tutorial_callbacks_smoothing.gif" />
</div>
</div>
<div class="section" id="dynamic-visualisation-in-rhino-with-conduits">
<h2>Dynamic visualisation in Rhino with conduits</h2>
</div>
<div class="section" id="applying-constraints">
<h2>Applying constraints</h2>
</div>
<div class="section" id="live-interaction">
<h2>Live interaction</h2>
</div>
</div>

                        
                    

                </main>

                

                <!-- site navigation sidebar -->

                <div class="col-12 col-md-3 col-xl-2 compas-sidebar" role="navigation"> 
                    <div class="navbar-light">

                        <form id="" class="d-flex compas-searchbox" action="../search.html" method="get">
                            <input class="form-control" type="text" name="q" placeholder="Search docs" />
                            <input type="hidden" name="check_keywords" value="yes" />
                            <input type="hidden" name="area" value="default" />

                            <button class="navbar-toggler d-md-none compas-navigation-toggler" type="button" data-toggle="collapse" data-target="#compas-navigation" aria-controls="compas-navigation" aria-expanded="false" aria-label="Toggle navigation">
                                <span class="navbar-toggler-icon"></span>
                            </button>
                        </form>

                        
                        

                            <div class="navbar-expand-md">
                                <div id="compas-navigation" class="collapse navbar-collapse compas-navigation">

                                <ul class="nav flex-column active">
<li class="nav-item"><a class="nav-link reference internal" href="../overview.html">Overview</a></li>
<li class="nav-item"><a class="nav-link reference internal" href="../gettingstarted.html">Getting started</a></li>
<li class="nav-item"><a class="nav-link reference internal" href="../environments.html">Environments</a></li>
<li class="nav-item"><a class="nav-link reference internal" href="../examples.html">Examples</a></li>
<li class="nav-item active"><a class="nav-link reference internal" href="../tutorials.html">Tutorials</a><ul class="nav active">
<li class="nav-item"><a class="nav-link reference internal" href="networks.html">Working with networks</a></li>
<li class="nav-item"><a class="nav-link reference internal" href="meshes.html">Working with meshes</a></li>
<li class="nav-item"><a class="nav-link reference internal" href="plotters.html">Working with plotters</a></li>
<li class="nav-item active"><a class="nav-link active current reference internal" href="#">Using callbacks</a></li>
<li class="nav-item"><a class="nav-link reference internal" href="geomaps.html">Using geometric maps</a></li>
<li class="nav-item"><a class="nav-link reference internal" href="packages.html">Making a Package</a></li>
<li class="nav-item"><a class="nav-link reference internal" href="xfunc.html">Writing XFuncs</a></li>
<li class="nav-item"><a class="nav-link reference internal" href="rpc.html">Setting up an RPC service</a></li>
<li class="nav-item"><a class="nav-link reference internal" href="toolbar.html">Making a Rhino toolbar</a></li>
<li class="nav-item"><a class="nav-link reference internal" href="plugins.html">Making a Rhino plugin</a></li>
</ul>
</li>
<li class="nav-item"><a class="nav-link reference internal" href="../api.html">API Reference</a></li>
<li class="nav-item"><a class="nav-link reference internal" href="../contributions.html">Contributions</a></li>
<li class="nav-item"><a class="nav-link reference internal" href="../changelog.html">Changelog</a></li>
<li class="nav-item"><a class="nav-link reference internal" href="../citing.html">Citing</a></li>
<li class="nav-item"><a class="nav-link reference internal" href="../license.html">License</a></li>
</ul>


                                </div>
                            </div>

                        

                    </div>
                </div>

                <!-- table of contents of main content -->

                <div class="d-none d-xl-block col-xl-2 compas-toc" role="toc">

                    

                    <ul class="nav flex-column" id="compas-localnav">
<li class="nav-item"><a class="nav-link reference internal" href="#">Using callbacks</a><ul class="nav">
<li class="nav-item"><a class="nav-link reference internal" href="#dynamic-plotting">Dynamic plotting</a></li>
<li class="nav-item"><a class="nav-link reference internal" href="#dynamic-visualisation-in-rhino-with-conduits">Dynamic visualisation in Rhino with conduits</a></li>
<li class="nav-item"><a class="nav-link reference internal" href="#applying-constraints">Applying constraints</a></li>
<li class="nav-item"><a class="nav-link reference internal" href="#live-interaction">Live interaction</a></li>
</ul>
</li>
</ul>


                </div>

                

            </div>
        </div>

        <footer class="compas-footer">
            
                
                    &#169; Copyright Block Research Group - ETH Zurich.
                
            

            
                Last updated on Apr 25, 2019.
            

            
                Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.0.1.
            
        </footer>

        

            <script type="text/javascript">
var DOCUMENTATION_OPTIONS = {
    URL_ROOT          : '',
    VERSION           : '0.5.2',
    COLLAPSE_INDEX    : false,
    FILE_SUFFIX       : '.html',
    HAS_SOURCE        : 'false',
    SOURCELINK_SUFFIX : '.txt'
};
            </script>

            <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>

            <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js" integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1" crossorigin="anonymous"></script>
            
            <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.0.0/anchor.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js"></script>

            <script src="../_static/underscore.js"></script>
            <script src="../_static/doctools.js"></script>
            <script src="../_static/js/searchtools_.js"></script>
            <script src="../_static/js/prism.js"></script>

            <script>
$(document).ready(function() {

    // $(".language-default pre").each(function(i, element) {
    //     Prism.highlightElement(element);
    // });

    // $(".language-bash pre").each(function(i, element) {
    //     Prism.highlightElement(element);
    // });

    // $(".language-python pre").each(function(i, element) {
    //     Prism.highlightElement(element);
    // });

    // $(".language-c pre").each(function(i, element) {
    //     Prism.highlightElement(element);
    // });

    // $(".language-cpp pre").each(function(i, element) {
    //     Prism.highlightElement(element);
    // });

    // $(".language-fortran pre").each(function(i, element) {
    //     Prism.highlightElement(element);
    // });

    // $(".language-markdown pre").each(function(i, element) {
    //     Prism.highlightElement(element);
    // });

    // $(".language-rest pre").each(function(i, element) {
    //     Prism.highlightElement(element);
    // });

    anchors.add();
});
            </script>

        
    </body>
</html>